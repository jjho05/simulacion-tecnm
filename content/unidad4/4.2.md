# 4.2 Aprendizaje y uso de un lenguaje de simulación o simulador

Esta sección proporciona una guía práctica completa para dominar herramientas de simulación, con énfasis en **SimPy** (Python) y **Arena**, las dos plataformas más relevantes para estudiantes y profesionales.

---

## Parte 1: SimPy - Tutorial Completo

### Instalación y Configuración

```bash
# Instalar SimPy
pip install simpy

# Instalar dependencias recomendadas
pip install numpy pandas matplotlib seaborn

# Verificar instalación
python -c "import simpy; print(f'SimPy {simpy.__version__} instalado correctamente')"
```

---

### Conceptos Fundamentales de SimPy

#### 1. Environment (Entorno)

El **Environment** es el núcleo de SimPy. Controla:
- El reloj de simulación (`env.now`)
- La lista de eventos futuros
- La ejecución de procesos

```python
import simpy

# Crear entorno
env = simpy.Environment()

# Tiempo actual
print(f"Tiempo inicial: {env.now}")  # 0

# Ejecutar hasta tiempo 100
env.run(until=100)
print(f"Tiempo final: {env.now}")  # 100
```

#### 2. Process (Proceso)

Un **Process** representa el comportamiento de una entidad a lo largo del tiempo.

**Características clave:**
- Definido como función generadora (usa `yield`)
- Puede pausarse y reanudarse
- Interactúa con recursos y otros procesos

```python
def mi_proceso(env, nombre):
    """Proceso simple que espera y ejecuta"""
    print(f'{nombre} inicia en t={env.now}')
    yield env.timeout(5)  # Esperar 5 unidades de tiempo
    print(f'{nombre} termina en t={env.now}')

env = simpy.Environment()
env.process(mi_proceso(env, 'Proceso A'))
env.run()
```

**Salida:**
```
Proceso A inicia en t=0
Proceso A termina en t=5
```

#### 3. Resource (Recurso)

Un **Resource** representa un servidor o recurso limitado.

**Operaciones:**
- `request()`: Solicitar el recurso
- `release()`: Liberar el recurso (automático con `with`)

```python
def cliente(env, nombre, servidor):
    print(f'{nombre} llega en t={env.now}')
    
    with servidor.request() as req:
        yield req  # Esperar hasta obtener el servidor
        print(f'{nombre} obtiene servidor en t={env.now}')
        yield env.timeout(3)  # Usar el servidor por 3 unidades
        print(f'{nombre} libera servidor en t={env.now}')

env = simpy.Environment()
servidor = simpy.Resource(env, capacity=1)

# Crear 3 clientes
for i in range(3):
    env.process(cliente(env, f'Cliente {i+1}', servidor))

env.run()
```

**Salida:**
```
Cliente 1 llega en t=0
Cliente 1 obtiene servidor en t=0
Cliente 2 llega en t=0
Cliente 3 llega en t=0
Cliente 1 libera servidor en t=3
Cliente 2 obtiene servidor en t=3
Cliente 2 libera servidor en t=6
Cliente 3 obtiene servidor en t=6
Cliente 3 libera servidor en t=9
```

---

### Ejemplo Completo: Sistema M/M/1

Simulación de una cola con llegadas Poisson y servicio exponencial.

```python
import simpy
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt

class SistemaMMC:
    """Simulador de sistema M/M/c"""
    
    def __init__(self, lambd, mu, c, tiempo_sim):
        self.lambd = lambd  # Tasa de llegadas
        self.mu = mu        # Tasa de servicio
        self.c = c          # Número de servidores
        self.tiempo_sim = tiempo_sim
        
        # Estadísticas
        self.tiempos_espera = []
        self.tiempos_sistema = []
        self.clientes_atendidos = 0
        
    def cliente(self, env, nombre, servidor):
        """Proceso de un cliente"""
        llegada = env.now
        
        with servidor.request() as req:
            yield req
            espera = env.now - llegada
            self.tiempos_espera.append(espera)
            
            # Tiempo de servicio
            tiempo_servicio = np.random.exponential(1/self.mu)
            yield env.timeout(tiempo_servicio)
            
            tiempo_total = env.now - llegada
            self.tiempos_sistema.append(tiempo_total)
            self.clientes_atendidos += 1
    
    def generador_llegadas(self, env, servidor):
        """Genera clientes con llegadas Poisson"""
        i = 0
        while True:
            yield env.timeout(np.random.exponential(1/self.lambd))
            i += 1
            env.process(self.cliente(env, f'Cliente {i}', servidor))
    
    def ejecutar(self):
        """Ejecutar simulación"""
        env = simpy.Environment()
        servidor = simpy.Resource(env, capacity=self.c)
        env.process(self.generador_llegadas(env, servidor))
        env.run(until=self.tiempo_sim)
        
        return self.obtener_estadisticas()
    
    def obtener_estadisticas(self):
        """Calcular estadísticas"""
        return {
            'clientes_atendidos': self.clientes_atendidos,
            'tiempo_espera_promedio': np.mean(self.tiempos_espera),
            'tiempo_sistema_promedio': np.mean(self.tiempos_sistema),
            'tiempo_espera_max': np.max(self.tiempos_espera),
            'utilizacion': self.lambd / (self.c * self.mu)
        }

# Ejemplo de uso
sistema = SistemaMMC(lambd=5, mu=6, c=1, tiempo_sim=1000)
stats = sistema.ejecutar()

print("=== RESULTADOS M/M/1 ===")
print(f"Clientes atendidos: {stats['clientes_atendidos']}")
print(f"Tiempo de espera promedio: {stats['tiempo_espera_promedio']:.2f}")
print(f"Tiempo en sistema promedio: {stats['tiempo_sistema_promedio']:.2f}")
print(f"Utilización: {stats['utilizacion']:.2%}")

# Comparar con teoría
rho = stats['utilizacion']
Wq_teorico = rho / (sistema.mu * (1 - rho))
W_teorico = 1/sistema.mu + Wq_teorico

print("\n=== COMPARACIÓN CON TEORÍA ===")
print(f"Wq simulado: {stats['tiempo_espera_promedio']:.2f}")
print(f"Wq teórico: {Wq_teorico:.2f}")
print(f"Error: {abs(stats['tiempo_espera_promedio'] - Wq_teorico)/Wq_teorico*100:.1f}%")
```

---

### Recursos Avanzados en SimPy

#### Container (Contenedor)

Para modelar inventarios o tanques con niveles continuos.

```python
def productor(env, contenedor):
    """Produce items y los agrega al contenedor"""
    while True:
        yield env.timeout(2)  # Producir cada 2 unidades
        yield contenedor.put(10)  # Agregar 10 unidades
        print(f'Producido 10, nivel={contenedor.level} en t={env.now}')

def consumidor(env, contenedor):
    """Consume items del contenedor"""
    while True:
        yield env.timeout(3)  # Consumir cada 3 unidades
        yield contenedor.get(7)  # Tomar 7 unidades
        print(f'Consumido 7, nivel={contenedor.level} en t={env.now}')

env = simpy.Environment()
contenedor = simpy.Container(env, capacity=100, init=50)

env.process(productor(env, contenedor))
env.process(consumidor(env, contenedor))
env.run(until=20)
```

#### Store (Almacén)

Para modelar inventarios de items individuales.

```python
def productor_items(env, almacen):
    """Produce items específicos"""
    for i in range(5):
        yield env.timeout(2)
        item = f'Item-{i}'
        yield almacen.put(item)
        print(f'Producido {item} en t={env.now}')

def consumidor_items(env, almacen):
    """Consume items"""
    while True:
        item = yield almacen.get()
        print(f'Consumido {item} en t={env.now}')
        yield env.timeout(3)

env = simpy.Environment()
almacen = simpy.Store(env, capacity=10)

env.process(productor_items(env, almacen))
env.process(consumidor_items(env, almacen))
env.run(until=20)
```

---

## Parte 2: Arena - Guía Práctica

### Interfaz de Arena

**Componentes principales:**
1. **Project Bar:** Módulos disponibles
2. **Model Window:** Área de trabajo
3. **Spreadsheet View:** Parámetros de módulos
4. **Run Controller:** Control de ejecución

### Módulos Básicos

#### 1. Create (Crear Entidades)

**Parámetros:**
- **Entity Type:** Tipo de entidad (Cliente, Pieza, etc.)
- **Time Between Arrivals:** Tiempo entre llegadas
  - Constant: Tiempo fijo
  - Exponential: Distribución exponencial
  - Normal, Triangular, etc.
- **Entities per Arrival:** Cuántas entidades por llegada
- **Max Arrivals:** Límite de entidades (Infinite por defecto)

**Ejemplo:**
```
Create Module: "Llegada Clientes"
- Entity Type: Cliente
- Time Between Arrivals: Exponential(10) minutes
- Entities per Arrival: 1
- Max Arrivals: Infinite
```

#### 2. Process (Procesar)

**Parámetros:**
- **Action:** Seize Delay Release (tomar recurso, esperar, liberar)
- **Resources:** Qué recursos se necesitan
- **Delay Type:** Distribución del tiempo de proceso
- **Priority:** Prioridad de la entidad

**Ejemplo:**
```
Process Module: "Atención"
- Action: Seize Delay Release
- Resources: Add → Cajero (1 unidad)
- Delay Type: Triangular(5, 8, 12) minutes
```

#### 3. Decide (Decisión)

**Tipos:**
- **2-way by Chance:** Probabilidad (ej: 70% A, 30% B)
- **2-way by Condition:** Condición lógica
- **N-way by Chance:** Múltiples opciones con probabilidades
- **N-way by Condition:** Múltiples condiciones

**Ejemplo:**
```
Decide Module: "Tipo de Cliente"
- Type: 2-way by Chance
- Percent True: 60
- True: Cliente Regular
- False: Cliente VIP
```

#### 4. Assign (Asignar)

Asigna valores a variables o atributos.

**Ejemplo:**
```
Assign Module: "Asignar Prioridad"
- Assignments:
  - myAttribute = 5
  - myVariable = myVariable + 1
```

#### 5. Record (Registrar)

Recolecta estadísticas.

**Tipos:**
- Count: Contador
- Entity Statistics: Tiempo en sistema, tiempo de espera
- Time Interval: Intervalo entre eventos

---

### Ejemplo Completo en Arena: Sistema de Banco

**Descripción:**
- Clientes llegan cada Exponencial(5) minutos
- 60% son clientes regulares, 40% VIP
- 2 cajeros disponibles
- Tiempo de servicio: Triangular(3, 5, 8) minutos
- Clientes VIP tienen prioridad

**Módulos:**

1. **Create:** "Llegada Clientes"
   - Time Between Arrivals: EXPO(5)

2. **Decide:** "Tipo Cliente"
   - 2-way by Chance: 60%

3. **Assign (Regular):** "Prioridad Regular"
   - myPriority = 2

4. **Assign (VIP):** "Prioridad VIP"
   - myPriority = 1

5. **Process:** "Atención Cajero"
   - Resources: Cajero (2)
   - Delay: TRIA(3, 5, 8)
   - Priority: myPriority (Low values first)

6. **Record:** "Tiempo Total"
   - Type: Entity Statistics
   - Attribute Name: Total Time

7. **Dispose:** "Salida"

**Configuración de corrida:**
- Replication Length: 480 minutes (8 horas)
- Number of Replications: 30

---

## Comparación SimPy vs Arena

| Aspecto | SimPy | Arena |
|---------|-------|-------|
| **Paradigma** | Código (Python) | Visual (drag-and-drop) |
| **Curva de aprendizaje** | Media (requiere Python) | Media (requiere conocer módulos) |
| **Flexibilidad** | Muy alta | Media |
| **Animación** | No incluida | Excelente |
| **Costo** | Gratis | ~$5,000-$10,000/año |
| **Reportes** | Manual (Pandas, Matplotlib) | Automáticos |
| **Mejor para** | Investigación, sistemas complejos | Manufactura, presentaciones |
| **Integración datos** | Excelente (Pandas, NumPy) | Buena (Excel, Access) |
| **Optimización** | Manual o librerías externas | OptQuest integrado |

---

## Mejores Prácticas de Modelado

### 1. Comenzar Simple

**Principio:** Modelo más simple primero, agregar complejidad gradualmente.

**Ejemplo:**
- **Versión 1:** Cola M/M/1 básica
- **Versión 2:** Agregar múltiples servidores
- **Versión 3:** Agregar prioridades
- **Versión 4:** Agregar variabilidad en llegadas

### 2. Documentar Supuestos

**Qué documentar:**
- Distribuciones usadas y su justificación
- Simplificaciones del sistema real
- Parámetros y sus fuentes

**Ejemplo de documentación:**
```python
"""
SUPUESTOS DEL MODELO:
1. Llegadas: Exponencial(10 min) - basado en datos históricos
2. Servicio: Triangular(5, 8, 12) - estimado por expertos
3. Capacidad: 2 servidores - configuración actual
4. Sin abandonos - simplificación (tasa real <1%)
5. Tiempo de simulación: 8 horas - jornada laboral
"""
```

### 3. Verificar Paso a Paso

**Checklist de verificación:**
- [ ] ¿Las entidades se crean correctamente?
- [ ] ¿Los recursos se toman y liberan?
- [ ] ¿Las estadísticas se recolectan?
- [ ] ¿El modelo termina correctamente?

**Técnica:** Ejecutar con pocos clientes y tiempos cortos primero.

### 4. Usar Semillas Fijas Durante Desarrollo

```python
# SimPy
np.random.seed(42)  # Reproducibilidad

# Arena
En Run Setup → Project Parameters → Random Number Streams
```

**Ventaja:** Resultados reproducibles para debugging.

### 5. Validar con Casos Conocidos

**Ejemplo:** Para M/M/1, comparar con fórmulas analíticas:

$$W_q = \frac{\rho}{\mu(1-\rho)}$$

```python
# Validación
rho = lambd / mu
Wq_teorico = rho / (mu * (1 - rho))
Wq_simulado = np.mean(tiempos_espera)

error = abs(Wq_simulado - Wq_teorico) / Wq_teorico
assert error < 0.05, f"Error demasiado grande: {error*100:.1f}%"
```

---

## Ejercicios Prácticos

### Ejercicio 1: SimPy - Sistema M/M/2

Modifique el ejemplo M/M/1 para tener 2 servidores. Compare resultados con teoría.

**Fórmulas M/M/c:**
$$P_0 = \left[\sum_{n=0}^{c-1}\frac{(c\rho)^n}{n!} + \frac{(c\rho)^c}{c!(1-\rho)}\right]^{-1}$$

$$L_q = P_0 \frac{(c\rho)^c \rho}{c!(1-\rho)^2}$$

### Ejercicio 2: Arena - Cafetería

Modele una cafetería con:
- Llegadas: EXPO(3) minutos
- 3 estaciones: Ordenar, Preparar, Pagar
- Tiempos: TRIA(1,2,3), TRIA(3,5,7), TRIA(0.5,1,1.5)
- 1 cajero para ordenar y pagar, 2 baristas

Simule 4 horas y reporte tiempo promedio en sistema.

---

## Recursos de Aprendizaje

### SimPy

**Documentación:**
- Oficial: https://simpy.readthedocs.io
- Ejemplos: https://github.com/simpy/simpy/tree/master/docs/examples

**Cursos:**
- Udemy: "Discrete Event Simulation with Python"
- YouTube: "SimPy Tutorial Series"

**Libros:**
- "Modeling and Simulation in Python" - Allen Downey

### Arena

**Documentación:**
- Arena Help (F1 en el software)
- Rockwell Automation University

**Cursos:**
- Coursera: "Simulation and Modeling"
- LinkedIn Learning: "Arena Simulation"

**Libros:**
- "Simulation with Arena" - Kelton, Sadowski, Zupick

---

## Resumen

**Para dominar simulación:**
1. **Entender conceptos:** Eventos, procesos, recursos
2. **Practicar con ejemplos simples:** M/M/1, inventarios básicos
3. **Incrementar complejidad gradualmente**
4. **Validar siempre:** Comparar con teoría o datos reales
5. **Documentar:** Supuestos, parámetros, resultados

**Herramienta recomendada para aprender:**
- **SimPy:** Si tienes experiencia en programación
- **Arena:** Si prefieres interfaz visual

---

*Referencia: Programa SCD-1022 - TecNM*
*Fuentes: SimPy Documentation, Arena User's Guide, Banks et al. (2010)*


---

<div align="center">

⬅️ [4.1 Lenguajes](4.1.md) &nbsp;&nbsp;|&nbsp;&nbsp; [4.3 Casos Prácticos](4.3.md) ➡️

</div>
